<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cicada 3301² – Dino Run (Encrypted Clue Reveal)</title>
  <style>
    :root{
      --bg:#0a0a0f; --fg:#e5e7eb; --muted:#9ca3af; --accent:#52ffa8;
      --card:#101118; --danger:#ef4444; --neon-green:#00ff88; --neon-blue:#00d4ff;
      --purple:#8b5cf6; --gold:#fbbf24;
    }
    *{box-sizing:border-box}
    html,body{
      height:100%; margin:0;
      font-family:'SF Pro Display', ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 30%, #16213e 70%, #0f0f1e 100%);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
      color:var(--fg);
      display:grid; place-items:center;
      overflow:hidden; position:relative;
    }
    @keyframes gradientShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .bg-particles{position:fixed; inset:0; pointer-events:none; z-index:-1}
    .particle{position:absolute; width:2px;height:2px; background:var(--accent); border-radius:50%; opacity:.6; animation:float 8s linear infinite}
    @keyframes float{0%{transform:translateY(100vh) translateX(0);opacity:0}10%,90%{opacity:.6}100%{transform:translateY(-10vh) translateX(20px);opacity:0}}

    .wrap{width:min(980px,96vw); animation:slideInUp .8s cubic-bezier(.16,1,.3,1); position:relative; z-index:10}
    @keyframes slideInUp{from{opacity:0; transform:translateY(30px) scale(.95)}to{opacity:1; transform:translateY(0) scale(1)}}

    header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px; padding:0 8px}
    h1{font-size:clamp(18px,2.6vw,26px); margin:0; background:linear-gradient(135deg,var(--neon-green),var(--neon-blue)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; font-weight:800; text-shadow:0 0 30px rgba(82,255,168,.3); animation:textGlow 3s ease-in-out infinite alternate}
    @keyframes textGlow{from{filter:brightness(1) drop-shadow(0 0 5px rgba(82,255,168,.3))}to{filter:brightness(1.1) drop-shadow(0 0 15px rgba(82,255,168,.5))}}
    .hint{color:var(--muted); font-size:13px; opacity:.85; animation:fadeInDelay 1s ease-out .5s both}
    @keyframes fadeInDelay{from{opacity:0; transform:translateX(10px)}to{opacity:.85; transform:translateX(0)}}

    .panel{background:linear-gradient(145deg, rgba(18,20,34,.9), rgba(14,15,23,.9)); backdrop-filter:blur(20px); border:1px solid rgba(82,255,168,.12); border-radius:24px; padding:18px; box-shadow:0 20px 60px rgba(0,0,0,.6), inset 0 0 0 1px rgba(82,255,168,.05), 0 0 40px rgba(82,255,168,.12); position:relative; overflow:hidden; animation:panelGlow 4s ease-in-out infinite alternate}
    @keyframes panelGlow{from{box-shadow:0 20px 60px rgba(0,0,0,.6), inset 0 0 0 1px rgba(82,255,168,.05), 0 0 40px rgba(82,255,168,.1)}to{box-shadow:0 20px 60px rgba(0,0,0,.6), inset 0 0 0 1px rgba(82,255,168,.1), 0 0 60px rgba(82,255,168,.16)}}
    .panel::before{content:''; position:absolute; top:0; left:-100%; width:100%; height:100%; background:linear-gradient(90deg, transparent, rgba(82,255,168,.08), transparent); animation:shimmer 3s linear infinite}
    @keyframes shimmer{0%{left:-100%}100%{left:100%}}

    canvas{display:block; width:100%; height:auto; background:linear-gradient(180deg,#0c0f1c 0%,#0b0d16 55%,#0a0a0f 100%); border-radius:18px; border:1px solid rgba(82,255,168,.2); box-shadow:inset 0 0 50px rgba(0,0,0,.5); transition:all .3s ease}
    canvas:hover{border-color:rgba(82,255,168,.4); box-shadow:inset 0 0 50px rgba(0,0,0,.5), 0 0 30px rgba(82,255,168,.2)}

    .hud{display:flex; align-items:center; justify-content:space-between; margin-top:12px; font-variant-numeric:tabular-nums; animation:slideInUp .8s ease-out .3s both; gap:12px}
    .btn-group{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{background:linear-gradient(145deg,#1e293b,#0f172a); border:1px solid rgba(82,255,168,.22); color:var(--fg); padding:10px 16px; border-radius:14px; cursor:pointer; font-weight:700; font-size:13px; transition:all .25s cubic-bezier(.4,0,.2,1); position:relative; overflow:hidden; text-transform:uppercase; letter-spacing:.5px}
    .btn::before{content:''; position:absolute; top:0; left:-100%; width:100%; height:100%; background:linear-gradient(90deg,transparent,rgba(82,255,168,.25),transparent); transition:left .45s}
    .btn:hover{background:linear-gradient(145deg,#2563eb,#1e40af); border-color:var(--neon-blue); transform:translateY(-2px); box-shadow:0 10px 25px rgba(37,99,235,.28), 0 0 20px rgba(0,212,255,.18)}
    .btn:hover::before{left:100%}
    .btn:active{transform:translateY(0) scale(.98)}

    .score{font-weight:900; font-size:18px; background:linear-gradient(135deg,var(--gold),var(--neon-green)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; text-shadow:0 0 20px rgba(251,191,36,.3); animation:scoreGlow 2s ease-in-out infinite alternate}
    @keyframes scoreGlow{from{filter:brightness(1)}to{filter:brightness(1.2) drop-shadow(0 0 10px rgba(251,191,36,.4))}}

    .footer{margin-top:12px; color:#9aa3c2; font-size:12px; text-align:center; animation:fadeInDelay 1s ease-out 1s both; padding:12px; background:linear-gradient(135deg, rgba(82,255,168,.05), rgba(139,92,246,.05)); border-radius:12px; border:1px solid rgba(82,255,168,.1)}

    .overlay{position:fixed; inset:0; display:none; place-items:center; backdrop-filter:blur(12px) saturate(120%); background:rgba(3,6,15,.78); z-index:50; animation:overlayFadeIn .45s ease-out}
    @keyframes overlayFadeIn{from{opacity:0; backdrop-filter:blur(0)}to{opacity:1; backdrop-filter:blur(12px)}}

    .glitchCard{width:min(900px,96vw); padding:36px 26px; text-align:center; border-radius:20px; background:linear-gradient(145deg, rgba(6,7,11,.95), rgba(11,14,20,.96)); border:2px solid rgba(82,255,168,.28); backdrop-filter:blur(18px); box-shadow:0 30px 80px rgba(0,0,0,.8), inset 0 0 0 1px rgba(82,255,168,.12), 0 0 60px rgba(82,255,168,.22); animation:cardSlideIn .55s cubic-bezier(.16,1,.3,1); position:relative; overflow:hidden}
    @keyframes cardSlideIn{from{opacity:0; transform:translateY(50px) scale(.9); filter:blur(10px)}to{opacity:1; transform:translateY(0) scale(1); filter:blur(0)}}

    .glitchText{font-family:'SF Mono','Monaco','Cascadia Code','Roboto Mono',monospace; font-weight:900; font-size:clamp(20px,5.2vw,44px); color:var(--accent); letter-spacing:1px; display:inline-block; position:relative; text-shadow:0 0 10px var(--accent), 0 0 20px var(--accent), 0 0 40px var(--accent); animation:textFlicker .1s linear infinite}
    @keyframes textFlicker{0%,95%,100%{opacity:1}96%,99%{opacity:.85}}
    .glitchText::before,.glitchText::after{content:attr(data-text); position:absolute; left:0; top:0; width:100%; height:100%}
    .glitchText::before{color:#00ff88; transform:translate(1.5px,-1px); mix-blend-mode:screen; filter:blur(.5px); opacity:.8; animation:glitchBefore .3s linear infinite}
    @keyframes glitchBefore{0%,100%{transform:translate(1.5px,-1px)}50%{transform:translate(2px,-1.5px)}}
    .glitchText::after{color:#ff0080; transform:translate(-1.5px,1px); mix-blend-mode:multiply; opacity:.75; animation:glitchAfter .2s linear infinite}
    @keyframes glitchAfter{0%,100%{transform:translate(-1.5px,1px)}50%{transform:translate(-2px,1.5px)}}

    .glitchSmall{color:#bcd2c8; margin-top:14px; font-size:16px; animation:fadeInUp .8s ease-out .3s both}
    .glitchHint{color:#9fb3a6; margin-top:12px; font-size:14px; font-style:italic; animation:fadeInUp .8s ease-out .5s both}
    @keyframes fadeInUp{from{opacity:0; transform:translateY(20px)}to{opacity:1; transform:translateY(0)}}

    .glitchButtons{display:flex; gap:12px; justify-content:center; margin-top:22px; animation:fadeInUp .8s ease-out .7s both; flex-wrap:wrap}

    .scan{position:absolute; inset:0; background:linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(82,255,168,.12) 40%, rgba(0,212,255,.1) 50%, rgba(82,255,168,.12) 60%, rgba(255,255,255,0) 100%); mix-blend-mode:overlay; pointer-events:none; animation:scanEnhanced 2s linear infinite}
    @keyframes scanEnhanced{from{transform:translateX(-120%) skewX(-15deg)}to{transform:translateX(120%) skewX(-15deg)}}

    .score-progress{position:relative; height:4px; background:rgba(82,255,168,.12); border-radius:2px; overflow:hidden; margin-top:6px}
    .score-bar{height:100%; background:linear-gradient(90deg, var(--neon-green), var(--neon-blue)); border-radius:2px; transition:width .25s ease; box-shadow:0 0 10px rgba(82,255,168,.5)}

    .game-over-overlay{position:absolute; inset:0; background:linear-gradient(135deg, rgba(239,68,68,.1), rgba(239,68,68,.06)); backdrop-filter:blur(5px); animation:gameOverFade .45s ease-out}
    @keyframes gameOverFade{from{opacity:0}to{opacity:1}}

    #mobile-warning{position:fixed; inset:0; display:none; z-index:999; background:linear-gradient(135deg, rgba(6,6,10,.98), rgba(12,12,16,.98)); color:var(--fg); display:grid; place-items:center; text-align:center; padding:28px; backdrop-filter:blur(20px)}
    #mobile-warning h2{margin:0 0 10px 0; font-size:clamp(18px,3vw,28px); color:var(--danger); text-shadow:0 0 20px var(--danger)}
    #mobile-warning p{margin:0; color:var(--muted)}

    @media (max-width:640px){ .wrap{width:100vw; padding:10px} .btn-group{justify-content:center} }
  </style>
</head>
<body>
<div class="bg-particles" id="bgParticles"></div>

<!-- Optional mobile message (kept hidden by default) -->
<div id="mobile-warning" role="alert" aria-live="polite" style="display:none">
  <div>
    <h2>🚫 Best on Laptop/PC</h2>
    <p>You can still play on mobile, but desktop feels smoother.</p>
  </div>
</div>

<div class="wrap" id="game-wrap" aria-hidden="false">
  <header>
    <h1>🦖 Dino Run – Cicada 3301² <span class="hint">(Clue decrypt puzzle)</span></h1>
    <div class="btn-group">
      <button id="fullscreenBtn" class="btn" title="Fullscreen (F)">⛶ Fullscreen</button>
      <button id="resetBtn" class="btn" title="Restart (R)">🔄 Restart</button>
    </div>
  </header>

  <div class="panel">
    <canvas id="game" width="960" height="260" aria-label="Dino game canvas"></canvas>
    <div class="hud">
      <div class="btn-group">
        <button id="jumpBtn" class="btn" title="Jump (Space/↑/Tap)">⬆️ Jump</button>
        <button id="duckBtn" class="btn" title="Duck (↓/S)">⬇️ Duck</button>
        <span class="hint">Space/↑ to jump • ↓/S to duck</span>
      </div>
      <div>
        <div class="score">Score: <span id="score">0</span></div>
        <div class="score-progress"><div class="score-bar" id="scoreBar" style="width:0%"></div></div>
      </div>
    </div>
  </div>

  <div class="footer">✨ Tip: The puzzle uses logical steps — no Base64 directly. When you reach <b>3301</b>, you'll see an <i>encrypted</i> string. Decrypt using the hint. ✨</div>
</div>

<!-- Glitch overlay -->
<div class="overlay" id="overlay" role="dialog" aria-modal="true">
  <div class="glitchCard" id="glitchCard">
    <div style="height:8px"></div>
    <div class="glitchText" id="glitchMain" data-text=""></div>
    <div class="scan" aria-hidden="true"></div>
    <div class="glitchSmall" id="glitchSmall">🔐 Encrypted fragment (copy & decode offline)</div>
    <div class="glitchHint" id="glitchHint">Hint: Work <b>in reverse</b> — first untangle neighbors, then step numerals <b>back three</b>.</div>
    <div class="glitchButtons" style="margin-top:16px">
      <button id="copyBtn" class="btn">📋 Copy encrypted</button>
      <button id="continueBtn" class="btn">🎮 Continue Game</button>
    </div>
  </div>
</div>

<script>
  /* =========================
     Constants & Difficulty
     ========================= */
  const TARGET_SCORE = 3301;
  const HARD_THRESHOLD = 2900;

  /* =========================
     Background Particles
     ========================= */
  function createBackgroundParticles(){
    const container = document.getElementById('bgParticles');
    for(let i=0;i<60;i++){
      const p=document.createElement('div');
      p.className='particle';
      p.style.left=Math.random()*100+'%';
      p.style.animationDelay=(Math.random()*8)+'s';
      p.style.animationDuration=(8+Math.random()*4)+'s';
      container.appendChild(p);
    }
  }

  /* =========================
     Obfuscated encrypted payload builder
     - We only reveal an encrypted string at 3301
     - The underlying plain URL is NOT present in the source
     ========================= */
  (function(){
    // base64 of encrypted text, split & shuffled with index tags
    // encrypted text corresponds to: pairwise-swap( digits+3 (mod 10) ) of the original
    const parts = [
      'p6:cnBhYy', 'p2:ZlbGU2', 'p1:bm9sZX', 'p4:VkZWtj', 'p7:Lm4=', 'p3:NjQzLj', 'p5:5zb2Np'
    ];
    const joined = parts
            .sort((a,b)=> parseInt(a.slice(1)) - parseInt(b.slice(1)))
            .map(s=> s.split(':')[1])
            .join('');
    const decode = (b64)=> (typeof atob==='function' ? atob(b64) : window.decodeURIComponent(window.escape(window.atob(b64))));
    const ENCRYPTED = decode(joined); // example: 'nolevele6643.5dekcrpac.soci.n'
    window._getEncrypted = ()=> ENCRYPTED;
  })();

  /* =========================
     Canvas Game
     ========================= */
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;

  const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  if(isMobile){ document.getElementById('mobile-warning').style.display = 'none'; }

  let last = performance.now();
  let running = true;
  let scoreFloat = 0, score = 0, clueShown = false;
  let isHard = false;
  let particles = [];
  let speed = 4.2; const gravity = 0.56;

  const ground = { y: H - 26 };

  const dino = {
    x: 64, y: ground.y - 48,
    baseW: 44, baseH: 48,
    w: 44, h: 48,
    vy: 0, onGround: true, isCrouching: false,
    animFrame: 0, animTimer: 0, squashTimer: 0,
    jump(){
      if(this.onGround && !this.isCrouching){
        this.vy = -12.6; this.onGround = false;
        this.w = this.baseW - 4; this.h = this.baseH + 4;
        // jump particles
        for(let i=0;i<8;i++){
          particles.push({
            x: this.x + this.w/2 + (Math.random()-.5)*20,
            y: this.y + this.h - 5,
            vx:(Math.random()-.5)*4, vy: Math.random()*-3-2,
            life:30+Math.random()*20, maxLife:30+Math.random()*20,
            color: `hsl(${140+Math.random()*40},100%,${60+Math.random()*20}%)`
          });
        }
      }
    },
    crouch(state){
      if(this.isCrouching===state) return;
      this.isCrouching = state;
      if(state){ this.w=58; this.h=28; this.y = ground.y - this.h; }
      else { this.w=this.baseW; this.h=this.baseH; this.y = ground.y - this.h; }
    }
  };

  const obstacles=[]; let spawnTimer = 0;
  function spawnObstacle(){
    const chanceFly = Math.random() > (isHard ? 0.55 : 0.9);
    if(chanceFly && score>250){
      const h = 18 + Math.random()*16;
      obstacles.push({ type:'flyer', x: W+40, y: ground.y - h - (Math.random()>0.5?64:40), w:42, h:26, animFrame:0, animTimer:0, glowPhase:0 });
    } else {
      const w = 22 + Math.random()*18, h = 34 + Math.random()*28;
      obstacles.push({ type:'cactus', x: W+40+Math.random()*40, y: ground.y - h, w, h, glowPhase:Math.random()*Math.PI*2 });
    }
  }

  function reset(){
    document.body.classList.remove('shake');
    running = true; score = 0; scoreFloat = 0; clueShown = false; isHard = false;
    speed = 4.2; spawnTimer = 0; obstacles.length = 0; particles.length = 0;
    dino.y = ground.y - dino.baseH; dino.vy = 0; dino.onGround = true; dino.crouch(false);
    document.getElementById('overlay').style.display='none';
    updateScoreBar();
    last = performance.now();
    requestAnimationFrame(loop);
  }

  function collide(a,b){ return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y; }
  function updateScoreBar(){ const progress = Math.min(score / TARGET_SCORE * 100, 100); document.getElementById('scoreBar').style.width = progress + '%'; }

  function drawGround(){
    const grad = ctx.createLinearGradient(0, ground.y, 0, H);
    grad.addColorStop(0,'#1a2332'); grad.addColorStop(1,'#0a0a0f');
    ctx.fillStyle = grad; ctx.fillRect(0, ground.y, W, H-ground.y);
    ctx.shadowBlur=10; ctx.shadowColor='#52ffa8'; ctx.fillStyle='#52ffa8'; ctx.fillRect(0, ground.y, W, 2); ctx.shadowBlur=0;
    ctx.fillStyle = '#334155';
    for(let i=0;i<W;i+=12){
      const x = (i - (performance.now()/6)%12 + W)%W;
      const opacity = 0.3 + Math.sin(performance.now()/500 + i/50) * 0.2;
      ctx.globalAlpha = opacity; ctx.fillRect(x, ground.y+8, 4, 4);
    }
    ctx.globalAlpha = 1;
  }

  function drawDino(){
    const d = dino; let bodyX=d.x, bodyY=d.y, bodyW=d.w, bodyH=d.h;
    ctx.shadowBlur=15; ctx.shadowColor='#e5e7eb'; ctx.fillStyle='#e5e7eb';
    if(d.squashTimer>0){ const s=Math.sin(d.squashTimer/120*Math.PI); bodyW+=s*12; bodyH-=s*10; bodyX-=s*6; bodyY+=s*5; }
    if(d.isCrouching){
      ctx.fillRect(bodyX, bodyY+4, bodyW, bodyH-4);
      ctx.fillRect(bodyX+bodyW-20, bodyY, 20, 12);
      ctx.fillStyle='#0a0a0f'; ctx.fillRect(bodyX+bodyW-6, bodyY+4, 4, 4);
    } else if(!d.onGround){
      ctx.save(); ctx.translate(bodyX+bodyW/2, bodyY+bodyH/2); ctx.rotate(Math.sin(performance.now()/200)*0.1); ctx.translate(-bodyW/2,-bodyH/2);
      ctx.fillRect(0,0,bodyW,bodyH); ctx.fillRect(bodyW-16,-8,20,20); ctx.fillStyle='#0a0a0f'; ctx.fillRect(bodyW-10,-6,4,4); ctx.restore();
    } else {
      const legOffset = d.animFrame===0?0:-8;
      ctx.fillRect(bodyX, bodyY, bodyW, bodyH-8); ctx.fillRect(bodyX+bodyW-16, bodyY-8, 20, 20);
      ctx.fillRect(bodyX+8, bodyY+bodyH-8, 8, 8+legOffset); ctx.fillRect(bodyX+26, bodyY+bodyH-8, 8, 8-legOffset);
      ctx.fillStyle='#0a0a0f'; ctx.fillRect(bodyX+bodyW-10, bodyY-6, 4, 4);
    }
    ctx.shadowBlur=0;
  }

  function drawObstacle(o){
    o.glowPhase += 0.05; const glow = 0.3 + Math.sin(o.glowPhase)*0.2;
    if(o.type==='cactus'){
      ctx.shadowBlur=8; ctx.shadowColor='#a5b4fc'; ctx.fillStyle = `rgba(165,180,252,${0.8+glow*0.2})`;
      const sway = Math.sin(performance.now()/300 + o.x/100) * 1;
      ctx.fillRect(o.x+sway, o.y, o.w, o.h); ctx.fillRect(o.x-6+sway, o.y+6, 6, 14); ctx.fillRect(o.x+o.w+sway, o.y+10, 6, 14);
    } else {
      ctx.shadowBlur=12; ctx.shadowColor='#fca5a5'; ctx.fillStyle = `rgba(252,165,165,${0.9+glow*0.1})`;
      const wingY = o.y + Math.sin(o.animFrame*.3)*8; const bob = Math.sin(performance.now()/200 + o.x/50)*2;
      ctx.fillRect(o.x+8, o.y+bob, o.w-16, o.h); ctx.fillRect(o.x, wingY+bob, o.w, 8);
    }
    ctx.shadowBlur=0;
  }

  function updateParticles(delta){
    for(let i=particles.length-1;i>=0;i--){
      const p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.vy+=0.1; p.life-=delta/16;
      if(p.life<=0){ particles.splice(i,1); continue; }
      const alpha=p.life/p.maxLife; ctx.globalAlpha=alpha; ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,2,2);
    }
    ctx.globalAlpha=1;
  }

  function update(delta){
    if(!isHard && score>=HARD_THRESHOLD){
      isHard=true; speed+=1.2; spawnTimer=Math.min(spawnTimer,520);
      document.body.style.transition='filter .8s ease'; document.body.style.filter='brightness(.9) saturate(1.2) hue-rotate(10deg)';
      setTimeout(()=>{ document.body.style.filter=''; canvas.style.boxShadow='inset 0 0 50px rgba(255,0,0,.3), 0 0 30px rgba(82,255,168,.4)'; setTimeout(()=>{canvas.style.boxShadow='inset 0 0 50px rgba(0,0,0,.5)'},500); },800);
    }
    speed += delta * 0.00028 * (isHard ? 1.6 : 0.9);

    dino.vy += gravity; dino.y += dino.vy;
    if(dino.y + dino.h >= ground.y){
      if(!dino.onGround){
        dino.squashTimer=120;
        for(let i=0;i<5;i++) particles.push({x:dino.x+dino.w/2+(Math.random()-.5)*30, y:ground.y, vx:(Math.random()-.5)*6, vy:Math.random()*-4-1, life:20+Math.random()*15, maxLife:20+Math.random()*15, color:'#52ffa8'});
      }
      dino.onGround=true; dino.y = ground.y - dino.h; dino.vy=0; if(!dino.isCrouching){ dino.w=dino.baseW; dino.h=dino.baseH; }
    }

    if(dino.onGround && !dino.isCrouching){
      dino.animTimer += delta; if(dino.animTimer > (180 - Math.min(40, speed*3))){ dino.animFrame=(dino.animFrame+1)%2; dino.animTimer=0; if(Math.random()>.7){ particles.push({x:dino.x+10, y:ground.y-5, vx:-2-Math.random()*2, vy:-1-Math.random(), life:15+Math.random()*10, maxLife:15+Math.random()*10, color:'#64748b'}); } }
    }
    if(dino.squashTimer>0) dino.squashTimer-=delta;

    spawnTimer -= delta; if(spawnTimer<=0){ spawnObstacle(); const base = isHard ? (560+Math.random()*420 - Math.min(speed*10,120)) : (920+Math.random()*520 - Math.min(speed*8,100)); spawnTimer = Math.max(380, base); }

    for(let i=obstacles.length-1;i>=0;i--){ const o=obstacles[i]; o.x -= speed*(delta/16); if(o.type==='flyer'){ o.animTimer += delta; if(o.animTimer>120){ o.animFrame++; o.animTimer=0; } } if(o.x + o.w < -40) obstacles.splice(i,1); if(collide({x:dino.x+4,y:dino.y+2,w:dino.w-8,h:dino.h-4}, o)) gameOver(); }

    updateParticles(delta);

    scoreFloat += delta * 0.13 * (isHard ? 1.04 : 1.0);
    const newScore = Math.floor(scoreFloat);
    if(newScore !== score){
      score = newScore; document.getElementById('score').textContent = score; updateScoreBar();
      if(score % 500 === 0 && score>0){ for(let i=0;i<15;i++) particles.push({x:W/2+(Math.random()-.5)*100, y:H/3, vx:(Math.random()-.5)*8, vy:Math.random()*-8-2, life:40+Math.random()*20, maxLife:40+Math.random()*20, color:`hsl(${Math.random()*60+40},100%,70%)`}); }
      if(score >= TARGET_SCORE && !clueShown){ revealEncrypted(); }
    }
  }

  function gameOver(){
    running=false; document.body.classList.add('shake');
    ctx.save(); ctx.globalAlpha = 0.2 + Math.sin(performance.now()/200)*0.1; ctx.fillStyle='#ef4444'; ctx.fillRect(0,0,W,H); ctx.globalAlpha=1; ctx.shadowBlur=20; ctx.shadowColor='#fca5a5'; ctx.fillStyle='#fca5a5'; ctx.font='bold 24px ui-sans-serif, system-ui'; ctx.textAlign='center'; ctx.fillText('Game Over', W/2, H/2 - 15); ctx.font='bold 16px ui-sans-serif, system-ui'; ctx.fillText('Press R to Restart', W/2, H/2 + 15); ctx.restore();
  }

  function render(){
    ctx.clearRect(0,0,W,H);
    for(let i=0;i<5;i++){ const sp = 30 + i*15; const x = ((performance.now()/sp) % (W+200)) - 100; const op = 0.15 + i*0.05 + Math.sin(performance.now()/1000 + i)*0.05; ctx.globalAlpha=op; ctx.fillStyle='#6b7280'; ctx.fillRect(W-x, 30+i*20, 60+i*15, 12+i*4); }
    ctx.globalAlpha=1;
    drawGround(); drawDino(); obstacles.forEach(drawObstacle); updateParticles(0);
    ctx.globalAlpha = 0.06 + Math.sin(performance.now()/2000)*0.02; ctx.shadowBlur=30; ctx.shadowColor='#52ffa8'; ctx.font='900 120px ui-sans-serif, system-ui'; ctx.fillStyle='#52ffa8'; ctx.textAlign='left'; ctx.fillText('3301', W-360, 140); ctx.shadowBlur=0; ctx.globalAlpha=1;
    if(speed>8){ ctx.globalAlpha=Math.min(0.4,(speed-8)/10); ctx.strokeStyle='#52ffa8'; ctx.lineWidth=1; for(let i=0;i<8;i++){ const y=Math.random()*H; const off=(performance.now()/10)%W; ctx.beginPath(); ctx.moveTo(-off + i*(W/4), y); ctx.lineTo(-off + i*(W/4) + 40, y); ctx.stroke(); } ctx.globalAlpha=1; }
  }

  function loop(t){ const delta = Math.min(50, t - last); last = t; if(running){ update(delta); render(); requestAnimationFrame(loop); } }

  /* =========================
     Encrypted Overlay Reveal
     ========================= */
  const overlay = document.getElementById('overlay');
  const glitchMain = document.getElementById('glitchMain');
  const glitchHint = document.getElementById('glitchHint');

  function revealEncrypted(){
    clueShown = true; running = false; canvas.style.transition='all .5s ease'; canvas.style.filter='blur(2px) brightness(.7)';
    setTimeout(()=>{ overlay.style.display='grid'; canvas.style.filter=''; }, 200);
    const encrypted = (typeof window._getEncrypted==='function') ? window._getEncrypted() : 'n/a';
    animateGlitch(encrypted, 'Hint: Work in reverse — untangle neighbors, then step numerals back three.');
  }

  function animateGlitch(target, hint){
    glitchHint.textContent = hint; const charset = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789.-#@$%&*+=<>?";
    let duration = 2200, frameTime = 35, elapsed = 0; let current = Array.from(target).map(()=> charset[Math.floor(Math.random()*charset.length)]);
    glitchMain.dataset.text = target;
    const timer = setInterval(()=>{
      elapsed += frameTime; for(let i=0;i<current.length;i++){ const chance = (elapsed/duration) + (i/(current.length*2.2)); if(Math.random()<chance) current[i] = target[i]; else if(Math.random()>.7) current[i] = charset[Math.floor(Math.random()*charset.length)]; }
      glitchMain.textContent = current.join('');
      if(elapsed>=duration){ clearInterval(timer); glitchMain.textContent = target; glitchMain.dataset.text = target; glitchMain.style.animation='none'; glitchMain.style.transform='scale(1.05)'; glitchMain.style.transition='transform .3s ease'; setTimeout(()=>{glitchMain.style.transform='scale(1)'},300); }
    }, frameTime);
  }

  /* =========================
     Controls & UI
     ========================= */
  const keys = {};
  function jumpAction(){ dino.jump(); const btn=document.getElementById('jumpBtn'); btn.style.transform='translateY(0) scale(.95)'; setTimeout(()=>{btn.style.transform=''},100); }
  function duckAction(state){ dino.crouch(state); const btn=document.getElementById('duckBtn'); if(state){ btn.style.transform='translateY(2px) scale(.98)'; btn.style.background='linear-gradient(145deg,#374151,#1f2937)'; } else { btn.style.transform=''; btn.style.background=''; } }

  document.getElementById('jumpBtn').addEventListener('pointerdown', jumpAction);
  document.getElementById('duckBtn').addEventListener('pointerdown', ()=>duckAction(true));
  document.getElementById('duckBtn').addEventListener('pointerup', ()=>duckAction(false));
  document.getElementById('resetBtn').addEventListener('click', ()=>{ const b=document.getElementById('resetBtn'); b.style.transform='rotate(180deg) scale(.9)'; b.style.transition='transform .4s ease'; setTimeout(()=>{ b.style.transform=''; reset(); }, 200); });

  document.getElementById('fullscreenBtn').addEventListener('click', ()=>{ const el=document.documentElement; if(!document.fullscreenElement){ (el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen).call(el); } else { (document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen).call(document); } });

  addEventListener('keydown', e=>{ if(keys[e.code]) return; keys[e.code]=true; if(e.code==='Space'||e.code==='ArrowUp'){ e.preventDefault(); jumpAction(); } if(e.code==='ArrowDown'||e.key==='s'||e.key==='S'){ e.preventDefault(); duckAction(true); } if(e.key==='r'||e.key==='R'){ reset(); } if(e.key==='f'||e.key==='F'){ document.getElementById('fullscreenBtn').click(); } });
  addEventListener('keyup', e=>{ keys[e.code]=false; if((e.code==='Space'||e.code==='ArrowUp') && dino.vy<-6){ dino.vy=-6; } if(e.code==='ArrowDown'||e.key==='s'||e.key==='S'){ e.preventDefault(); duckAction(false); } });

  canvas.addEventListener('pointerdown', jumpAction);

  document.getElementById('copyBtn').addEventListener('click', async ()=>{
    try{ const enc = (typeof window._getEncrypted==='function') ? window._getEncrypted() : ''; await navigator.clipboard.writeText(enc); const btn=document.getElementById('copyBtn'); const t=btn.textContent; btn.textContent='✅ Copied!'; btn.style.background='linear-gradient(145deg,#10b981,#059669)'; btn.style.borderColor='#10b981'; setTimeout(()=>{btn.textContent=t; btn.style.background=''; btn.style.borderColor='';}, 1400); }catch{ alert('Copy failed'); }
  });

  document.getElementById('continueBtn').addEventListener('click', ()=>{ overlay.style.animation='overlayFadeOut .3s ease-out forwards'; setTimeout(()=>{ overlay.style.display='none'; overlay.style.animation=''; running=true; requestAnimationFrame(loop); }, 280); });

  // secret skip code: type "skip3301" to pop the clue
  let skipBuffer = ""; const skipCode = "skip3301";
  window.addEventListener('keydown', (e)=>{ if(clueShown) return; if(/^[a-z0-9]$/i.test(e.key)){ skipBuffer += e.key.toLowerCase(); if(skipBuffer.length>skipCode.length) skipBuffer = skipBuffer.slice(-skipCode.length); if(skipBuffer===skipCode){ document.body.style.filter='hue-rotate(120deg) saturate(1.5)'; setTimeout(()=>{ document.body.style.filter=''; revealEncrypted(); }, 280); skipBuffer=''; } } });

  // Add overlay fade out keyframes dynamically
  const dyn = document.createElement('style'); dyn.textContent = `@keyframes overlayFadeOut{from{opacity:1; backdrop-filter:blur(12px)}to{opacity:0; backdrop-filter:blur(0)}}`; document.head.appendChild(dyn);

  // Initialize
  function init(){ createBackgroundParticles(); requestAnimationFrame(loop); }
  init();
</script>
</body>
</html>
